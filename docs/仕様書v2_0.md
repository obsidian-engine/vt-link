✅ **コンテキスト / 目的 / 前提******

**目的**：**フロントだけ**着手する場合と、**バックエンドだけ**着手する場合の**最短ToDo**をそれぞれ切り出し。

**前提**：完全無料構成（**Vercel Hobby + Cloudflare Workers(Cron) + Neon/Supabase(Postgres Free) + LINE Developer**）、モノレポ、**Zod → OpenAPI → 型生成**のパイプライン。
* * *

## **✅ フロントだけ着手する順序（UI/型まわり先行）**



**ゴール**：スキーマ由来の**型安全クライアント**でダミー/実APIに接続し、**一覧 + 作成フォーム**が動作。



### **1) 依存と環境の用意**

- **やること**：ワークスペース有効化、依存導入、生成系を動かす。
- **コマンド**


    corepack enable
    pnpm i -w
    pnpm gen  # Zod->OpenAPI->Types を一括生成

- **Done**：packages/api-client/src/__generated__/types.ts が生成。



### **2) .env 設定（フロントだけ）**

- **やること**：APIベースURLを環境変数で切替。
- **ファイル**：apps/frontend/.env.development


    # 実APIを叩くとき
    NEXT_PUBLIC_API_BASE=http://localhost:8080
    # モックを叩くとき（推奨：バックエンド未着手でも進められる）
    # NEXT_PUBLIC_API_BASE=http://localhost:4010

- **Done**：process.env.NEXT_PUBLIC_API_BASE が参照される。



### **3) モックで先に疎通（バックエンド未完成でも進める）**

- **やること**：Prismモックを起動してAPI契約を前提にUI実装。
- **コマンド**


    npx @stoplight/prism-cli mock packages/schema-zod/openapi.yaml --port 4010
    pnpm -C apps/frontend dev -p 3000

- **Done**：http://localhost:3000 でダッシュボード表示、**エラー無**。



### **4) 型安全クライアントの導入**

- **やること**：openapi-fetch + 生成型でGET/POST実装。
- **ファイル**：apps/frontend/app/page.tsx（一覧）、app/campaign/new/page.tsx（作成）
- **ポイント**：**res.error を必ず確認**、SWRキーは['/api/v1/campaigns','listCampaigns']のように一意に。
- **Done**：**一覧が表示**され、**作成後に一覧へ反映**（SWR mutate 等）。



### **5) フォーム検証（Zod / react-hook-form）**

- **やること**：**同一Zod定義**（可能なら packages/schema-zod をimport）でクライアント検証。
- **Done**：title/body 未入力で**ユーザーに警告**、送信不可。



### **6) 品質ゲート（フロント観点）**

- **やること**：**Spectral Lint**、**型生成差分のレビュー必須化**。
- **コマンド**


    npx @stoplight/spectral-cli lint packages/schema-zod/openapi.yaml
    pnpm gen && git diff --exit-code -- packages/api-client/src/__generated__/types.ts
- **Done**：PRで「型生成差分なし」or「意図した差分」のどちらかが確認できる。



### **7) デプロイ（無料）**

- **やること**：GitHub 連携 → **Vercel** にImport。環境変数 NEXT_PUBLIC_API_BASE を Vercel の Project Settings へ（最初は https://<project>.vercel.app を指す想定、バックエンドがVercel Go Functionsになったら同一オリジン化）。
- **Done**：<project>.vercel.app が公開。API未実装時はモックに向ける。



**⚠ よくある落とし穴（フロント）******

- **BASE URLの末尾スラ**重複で404（https://...に統一）
- **res.error未チェック**で落ちる
- SWRキーの一意性不足でキャッシュ衝突
* * *

## **✅ バックエンドだけ着手する順序（API/ユースケース先行）**



**ゴール**：**Vercel Go Functions**で /api/* を提供、**Neon/Supabase**接続、**/api/scheduler/run** を **Cloudflare Workers（Cron）**から叩いて動作。



### **1) DB 準備（Neon or Supabase Free）**

- **やること**：DB作成、接続文字列取得。
- **Done**：DATABASE_URL=postgres://... を入手。



### **2) 環境変数（VercelのProject Settingsへ）**

- **やること**：**サーバサイド用**の秘密情報を登録。
- **キー**：DATABASE_URL, JWT_SECRET, LINE_ACCESS_TOKEN, LINE_CHANNEL_ID, LINE_CHANNEL_SECRET
- **Done**：Vercel上の**Go Functions**が全て参照可能。



### **3) マイグレーション（無料で回す）**

- **やること**：ローカル/CI から goose up を実行して Neon/Supabase に適用。
- **コマンド（ローカル例）**


    export DB_URL="postgres://...your neon or supabase ..."
    cd apps/backend
    go install github.com/pressly/goose/v3/cmd/goose@latest
    goose -dir ./migrations postgres "$DB_URL" up

- **Done**：users/campaigns テーブルが作成済み。



### **4) API 実装（Vercelの Go Serverless Functions）**

- **やること**：/api/campaigns（GET/POST）、/api/campaigns/:id/send、/api/healthz を実装。
- **ポイント**：**接続リトライ**（Neonのスリープ対策）、**短時間で返す**（無料枠の実行時間対策）。
- **Done**：curl https://<project>.vercel.app/api/healthz が **200**。



### **5) スケジューラ用エンドポイント**

- **やること**：POST /api/scheduler/run（**scheduled_at <= now** 送信＆更新）を実装。
- **Done**：手動 curl -X POST で、対象が sent に更新されること。



### **6) Cloudflare Workers（Cron）で毎分キック**

- **やること**：**Cron Trigger** で /api/scheduler/run を呼ぶ**軽いWorker**をデプロイ。
- **設定**：wrangler.toml（crons = ["*/1 * * * *"]）、JOB_ENDPOINT/JOB_SECRET をSecretに。
- **Done**：Cloudflare ダッシュボードの**実行ログ**で毎分成功を確認。



### **7) LINE Push 実装 & 秘密の取り扱い**

- **やること**：LINE_ACCESS_TOKEN で https://api.line.me/v2/bot/message/push を叩く。
- **Done**：テストCHへ送信成功。**失敗ログ**を出し、レート制御/指数バックオフの骨子も入れる。



### **8) /openapi.yaml の配信（スキーマ整合の公開点）**

- **やること**：**Zod生成物**（packages/schema-zod/openapi.yaml）を**静的配信**（Echo or Vercel Static）。
- **Done**：GET https://<project>.vercel.app/openapi.yaml で取得可（フロント/外部ツールから参照）。



### **9) 品質・テスト（バックエンド観点）**

- **やること**：Usecase ユニット（Repo/Pusher/Clock/Txをモック）、Repo結合（Neon/Supabaseに対して read-only でも可）。
- **コマンド（例）**


    go test ./...

- **Done**：主要ユースケース（作成/即時送信/スケジューラ1回）が**緑**。



**⚠ よくある落とし穴（バックエンド）******

- **Vercel Go のタイムアウト/メモリ**超過（長処理はやらない）
- **Neon/Supabaseのスリープ**で初回接続エラー（**リトライ**を入れる）
- **LINEレート**（失敗時の再試行を最低限入れる）
* * *

## **✅ どちらにも共通（先に決めておくと事故らない）**

- **スキーマは常に Zod が源泉** → pnpm gen 前提で作業する
- **Spectral Lint** と **型生成ファイルの差分レビュー**を**PR必須**に
- **モック（Prism）運用**：バックエンド未完成でもフロントを先行可能
- **環境変数命名**：**ブラウザ露出は NEXT_PUBLIC_* のみ**、その他は**秘密**として管理
* * *

## **✅ 最短で本線に乗せるための「ミニWBS」**



### **フロントだけ（最短3ステップ）**

1. pnpm gen → Prismモック起動 → NEXT_PUBLIC_API_BASE=http://localhost:4010

2. 一覧ページ（SWR/GET）→ 作成フォーム（POST/楽観更新）

3. Spectral Lint + 型差分チェック → Vercelへデプロイ



### **バックエンドだけ（最短4ステップ）**

1. Neon/Supabase作成 → DATABASE_URL 設定 → goose up

2. /api/campaigns GET/POST + /api/healthz（Go Functions）

3. /api/scheduler/run 実装 → Cloudflare Workers（Cron）毎分

4. /openapi.yaml 配信 → フロントが型生成に利用

* * *