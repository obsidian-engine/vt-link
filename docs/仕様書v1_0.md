✅ **VT-Line Monorepo 本番デプロイ仕様書******

* * *

# **VT-Line -- Monorepo 構成 & 本番デプロイ指示書**



このドキュメントは、**フロントエンド（Next.js 15/React）** と **バックエンド（Go 1.24/Echo）** をモノレポで管理し、**ローカル開発から本番デプロイ**までを統一的に扱うための構成と手順をまとめたものです。
* * *

## **1. ディレクトリ構成**


    vt-line/
    ├── apps/
    │   ├── backend/                # Go 1.24 APIサーバ
    │   │   ├── cmd/server/main.go
    │   │   ├── internal/api/...
    │   │   ├── internal/domain/...
    │   │   ├── internal/infrastructure/...
    │   │   ├── migrations/...
    │   │   └── go.mod
    │   └── frontend/               # Next.js 15 (React)
    │       ├── app/...
    │       ├── components/...
    │       ├── lib/...
    │       ├── styles/...
    │       ├── package.json
    │       └── tsconfig.json
    ├── packages/
    │   ├── shared-types/            # TS型共有
    │   ├── shared-config/           # ESLint, tsconfig, prettier共有
    │   └── go-commons/              # Goユーティリティ共有
    ├── infra/
    │   ├── docker/                  # Dockerfiles / Compose定義
    │   └── caddy/Caddyfile          # 本番TLSリバースプロキシ設定
    ├── scripts/                     # 開発/運用補助スクリプト
    │   ├── migrate.sh
    │   ├── seed.sh
    │   └── healthz.sh
    ├── .github/workflows/deploy.yml # CI/CD用
    ├── .env.example                 # 環境変数サンプル
    ├── go.work                      # Goワークスペース管理
    ├── package.json                 # pnpm root
    ├── pnpm-workspace.yaml
    ├── turbo.json                   # 任意: Turborepo設定
    ├── Makefile                     # 共通コマンドエントリ
    └── README.md

* * *

## **2. 技術スタック**

- **フロントエンド**: Next.js 15 (React 18), TypeScript, Tailwind CSS, SWR, Zustand
- **バックエンド**: Go 1.24, Echo, sqlx, Postgres
- **データベース**: Postgres (Docker)
- **リバースプロキシ / TLS**: Caddy (Let's Encrypt 自動証明書)
- **モノレポ管理**: pnpm workspaces + go.work
- **CI/CD**: GitHub Actions + SSHデプロイ
* * *

## **3. 環境変数管理**



ルート .env.example に一覧を集約し、各アプリごとに分離して利用します。


    # === Backend ===
    DB_URL=postgres://vtline:vtlinepass@db:5432/vtline?sslmode=disable
    JWT_SECRET=CHANGE_ME_32CHARS_MIN
    LINE_CHANNEL_ID=
    LINE_CHANNEL_SECRET=
    LINE_ACCESS_TOKEN=
    
    # === Frontend ===
    NEXT_PUBLIC_API_BASE=https://vt-line.example.com

- **apps/backend/.env** → DB_URL, JWT_SECRET, LINE_*
- **apps/frontend/.env.production** → NEXT_PUBLIC_*
* * *

## **4. 開発環境セットアップ**



### **4.1 前提**

- Node.js 20.x (pnpm 9.x, corepack enable)
- Go 1.24
- Docker & Compose



### **4.2 初期化**


    git clone git@github.com:yourname/vt-line.git
    cd vt-line
    corepack enable
    pnpm i -w

### **4.3 ローカルDB起動**


    make db-up   # Postgres起動 (infra/docker/compose.local.yml)

### **4.4 開発サーバ起動**


    make dev     # Go(air) + Next.js(dev) 同時起動

アクセス:

- Backend → http://localhost:8080/healthz
- Frontend → http://localhost:3000
* * *

## **5. 本番デプロイ構成**



### **5.1 インフラ要件**

- **VPS**: Ubuntu 22.04+, 1 vCPU / 1GB RAM / 20GB SSD
- **DNS**: vt-line.example.com → VPS IPv4
- **ポート**: 22, 80, 443



### **5.2 コンテナ構成（prod）**

- **caddy**: TLS + リバースプロキシ
- **frontend**: Next.js SSR
- **backend**: Go Echo API
- **db**: Postgres 16



infra/docker/compose.prod.yml で定義。



### **5.3 Caddyfile**


    vt-line.example.com {
      encode gzip zstd
      @api path /api/* /healthz
      handle @api {
        reverse_proxy backend:8080
      }
      handle {
        reverse_proxy frontend:3000
      }
      log {
        output stdout
        format json
      }
    }

### **5.4 デプロイ手順**


    # VPS内
    cd ~/apps/vt-line/infra/docker
    docker compose -f compose.prod.yml up -d --build

確認:

- https://vt-line.example.com/
- https://vt-line.example.com/healthz
* * *

## **6. CI/CD（GitHub Actions）**



.github/workflows/deploy.yml


    name: Deploy to VPS
    on:
      push:
        branches: [ main ]
    
    jobs:
      deploy:
        runs-on: ubuntu-latest
        steps:
          - name: SSH & Deploy
            uses: appleboy/ssh-action@v1
            with:
              host: ${{ secrets.VPS_IP }}
              username: vtline
              key: ${{ secrets.VPS_KEY }}
              script: |
                set -e
                if [ ! -d ~/apps/vt-line ]; then mkdir -p ~/apps && cd ~/apps && git clone ${{ secrets.REPO_SSH }} vt-line; fi
                cd ~/apps/vt-line
                git pull --rebase
                cd infra/docker
                docker compose -f compose.prod.yml up -d --build
                docker image prune -f

* * *

## **7. 運用オペレーション**

- **ログ確認**


    make logs

- **DBマイグレーション**


    make migrate

- **シード投入**


    make seed

- **ヘルスチェック**


    scripts/healthz.sh https://vt-line.example.com/healthz

- **バックアップ**


    docker exec vtline-db pg_dump -U vtline vtline | gzip > backup.sql.gz

* * *

📌 **まとめ******

- モノレポ: apps/（実行物） + packages/（共有） + infra/（基盤）
- ローカル: DBだけDocker → Go/Next.jsはホストでホットリロード
- 本番: VPS 1台, CaddyでTLS自動化, Composeで一体運用
- CI/CD: GitHub Actions → SSHデプロイ
* * *